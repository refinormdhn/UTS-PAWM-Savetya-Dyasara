<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interactive Quiz</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #bae8e8 0%, #e3f6f5 100%);
      margin: 0;
      padding: 0;
    }
    nav {
      background: #fff;
      padding: 1rem 3rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 50px;
    }
    .nav-logo {
      cursor: pointer;
      line-height: 0;
    }
    .nav-logo img {
      height: 50px;
      width: auto;
      display: block;
    }
    .nav-menu {
      display: flex;
      list-style: none;
      gap: 3rem;
      align-items: center;
      margin: 0;
      padding: 0;
    }
    .nav-menu li {
      margin: 0;
      padding: 0;
      line-height: 1;
    }
    .nav-menu a {
      text-decoration: none;
      color: #272643;
      font-weight: 600;
      font-size: 1.2rem;
      transition: color 0.3s ease;
      position: relative;
    }
    .nav-menu a:hover {
      color: #2C698D;
    }
    .nav-menu a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: #2C698D;
      transition: width 0.3s ease;
    }
    .nav-menu a:hover::after {
      width: 100%;
    }
    .quiz-container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 2rem;
    }
    .quiz-selection,
    .question-card,
    .result-card {
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }
    .quiz-option {
      background: linear-gradient(135deg, #2c698d 0%, #1e4d6b 100%);
      color: #fff;
      padding: 1.5rem;
      border-radius: 10px;
      cursor: pointer;
      margin: 0.5rem 0;
      text-align: center;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .quiz-option:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(44, 105, 141, 0.3);
    }
    .question-number {
      font-weight: 600;
      color: #2c698d;
      margin-bottom: 1rem;
    }
    .question-text {
      font-size: 1.2rem;
      color: #272643;
      margin-bottom: 1rem;
    }
    .options-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    .option {
      background: #2c698d;
      color: #fff;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      cursor: grab;
      transition: background 0.2s;
    }
    .option:hover {
      background: #1e4d6b;
    }
    .answer-area {
      border: 3px dashed #2c698d;
      border-radius: 12px;
      background: #e3f6f5;
      padding: 2rem;
      text-align: center;
      margin: 1.5rem 0;
      min-height: 100px;
      transition: all 0.3s;
    }
    .answer-area.drag-over {
      background: #bae8e8;
      transform: scale(1.02);
    }
    .filled {
      background: #bae8e8;
    }
    .nav-button {
      background: #2c698d;
      color: #fff;
      border: none;
      padding: 0.8rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin: 1rem 0.5rem;
    }
    .nav-button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    footer {
      text-align: center;
      color: #fff;
      background: #272643;
      padding: 1rem;
      margin-top: 4rem;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s ease;
    }

    .modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
      animation: slideUp 0.3s ease;
    }

    .modal-content h3 {
      color: #272643;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    .modal-content p {
      color: #666;
      margin-bottom: 2rem;
    }

    .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .modal-button {
      padding: 0.8rem 2rem;
      border: none;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
    }

    .modal-button.confirm {
      background: #e74c3c;
      color: white;
    }

    .modal-button.confirm:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .modal-button.cancel {
      background: #95a5a6;
      color: white;
    }

    .modal-button.cancel:hover {
      background: #7f8c8d;
      transform: translateY(-2px);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <nav>
    <div class="nav-container">
      <div class="nav-logo" onclick="window.location.href='index.html'">
        <img src="img/logo.png" alt="Logo">
      </div>
      <ul class="nav-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="learn.html">Learn</a></li>
        <li><a href="quiz.html">Quiz</a></li>
        <li><img src="img/profile.png" alt="Profile" id="profileIcon" style="height: 40px; width: 40px; border-radius: 50%; cursor: pointer; object-fit: cover;"></li>
      </ul>
    </div>
  </nav>

  <div class="quiz-container">
    <!-- QUIZ SELECTION -->
    <div id="quizSelection" class="quiz-selection">
      <h2>Select Material</h2>
      <p>Choose a quiz topic below:</p>
      <div class="quiz-option" onclick="startQuiz(1)">ðŸ§­ Engaging Your Audience</div>
      <div class="quiz-option" onclick="startQuiz(2)">ðŸ“Š Visual Aids & Body</div>
      <div class="quiz-option" onclick="startQuiz(3)">ðŸŽ¤ Handling Questions</div>
      <div class="quiz-option" onclick="startQuiz(4)">ðŸª¶ Delivery Techniques</div>
    </div>

    <!-- QUIZ CONTENT -->
    <div id="quizContent" style="display:none;">
      <div class="question-card">
        <div id="questionNumber" class="question-number"></div>
        <div id="questionText" class="question-text"></div>

        <div id="answerArea" class="answer-area">
          <span style="color:#888">Drag options here to order your answer</span>
        </div>
        <div class="options-container" id="optionsContainer"></div>
      </div>

      <div style="text-align:center;">
        <button class="nav-button" id="prevButton" disabled>Previous</button>
        <button class="nav-button" id="nextButton">Next</button>
      </div>
    </div>

    <!-- RESULT CARD -->
    <div id="resultCard" class="result-card" style="display:none;">
      <h2>ðŸŽ‰ Quiz Complete!</h2>
      <p><strong>Your Score:</strong> <span id="scoreDisplay"></span></p>
      <button class="nav-button" onclick="backToSelection()">Back to Materials</button>
    </div>
  </div>

  <footer>Â© 2025 Interactive Learning | PAWM Project</footer>

  <!-- Logout Modal -->
  <div id="logoutModal" class="modal">
    <div class="modal-content">
      <h3>Logout Confirmation</h3>
      <p>Are you sure you want to logout?</p>
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeLogoutModal()">Cancel</button>
        <button class="modal-button confirm" onclick="confirmLogout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- ===================== JS Logic ====================== -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // SETUP SUPABASE CLIENT
    const SUPABASE_URL = "https://zvkelfhmrjfvveembihp.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2a2VsZmhtcmpmdnZlZW1iaWhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NTQxOTIsImV4cCI6MjA3NjIzMDE5Mn0.pYNKv2BwrWwG2eJDrPBlXr8S3lLptoVph9Ql0y4IIO0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // VARIABEL GLOBAL
    let questions = [];
    let userAnswers = [];
    let currentMaterial = 0;
    let currentQuestion = 0;
    let draggedElement = null;

    // MULAI QUIZ
    window.startQuiz = async function (materialNum) {
      currentMaterial = materialNum;
      document.getElementById("quizSelection").style.display = "none";
      document.getElementById("quizContent").style.display = "block";

      // Fetch questions dari quiz_questions
      const { data: questionsData, error: questionsError } = await supabase
        .from("quiz_questions")
        .select("*")
        .eq("topic", materialNum)
        .order("id");

      if (questionsError) {
        console.error(questionsError);
        alert("Failed to load questions from Supabase!");
        return;
      }

      // Fetch options untuk setiap question dari quiz_options
      const questionsWithOptions = await Promise.all(
        questionsData.map(async (question) => {
          console.log("Fetching options for question ID:", question.id); // Debug

          const { data: optionsData, error: optionsError } = await supabase
            .from("quiz_options")
            .select("option_text")
            .eq("question_id", question.id)
            .order("id");

          if (optionsError) {
            console.error("Error fetching options for question", question.id, optionsError);
            return { ...question, options: [] };
          }

          console.log("Options data for question", question.id, ":", optionsData); // Debug

          // Extract option_text dari array of objects menjadi array of strings
          let optionsArray = optionsData ? optionsData.map(opt => opt.option_text) : [];

          // FALLBACK: Jika quiz_options kosong, gunakan kolom options (JSON) dari quiz_questions
          if (optionsArray.length === 0 && question.options) {
            console.log("Using fallback options from question.options");
            try {
              if (typeof question.options === 'string') {
                optionsArray = JSON.parse(question.options);
              } else if (Array.isArray(question.options)) {
                optionsArray = question.options;
              }
            } catch (e) {
              console.error("Error parsing fallback options:", e);
              optionsArray = [];
            }
          }

          console.log("Options array for question", question.id, ":", optionsArray); // Debug

          return { ...question, options: optionsArray };
        })
      );

      console.log("All questions with options:", questionsWithOptions); // Debug

      questions = questionsWithOptions;
      currentQuestion = 0;
      userAnswers = [];
      loadQuestion();
    };

    // TAMPILKAN PERTANYAAN
    function loadQuestion() {
      const q = questions[currentQuestion];
      const questionIndex = currentQuestion + 1; // 1-based index
      const isOrderingQuestion = (questionIndex === 5); // Pertanyaan nomor 5 adalah ordering question

      document.getElementById("questionNumber").textContent =
        "Question " + questionIndex + " of " + questions.length;
      document.getElementById("questionText").textContent = q.question;

      const answerArea = document.getElementById("answerArea");

      if (isOrderingQuestion) {
        answerArea.innerHTML = '<span style="color:#888">Drag and arrange all options in the correct order</span>';
      } else {
        answerArea.innerHTML = '<span style="color:#888">Drag one option here</span>';
      }
      answerArea.classList.remove("filled");

      // Options sudah dalam bentuk array dari quiz_options table
      let opts = q.options || [];

      console.log("Options loaded:", opts); // Debug log
      console.log("Is ordering question:", isOrderingQuestion); // Debug log

      const container = document.getElementById("optionsContainer");
      container.innerHTML = "";

      // Track current order in answer area
      if (!Array.isArray(userAnswers[currentQuestion])) {
        userAnswers[currentQuestion] = [];
      }

      // Render options in optionsContainer (only those not in answer area)
      opts.forEach((opt) => {
        if (!userAnswers[currentQuestion].includes(opt)) {
          const div = document.createElement("div");
          div.classList.add("option");
          div.textContent = opt;
          div.draggable = true;
          div.ondragstart = (e) => dragStartOption(e, opt, false);
          container.appendChild(div);
        }
      });

      // Render answer in answerArea
      if (userAnswers[currentQuestion] && userAnswers[currentQuestion].length > 0) {
        answerArea.innerHTML = ''; // Clear placeholder text
        answerArea.classList.add("filled");

        if (isOrderingQuestion) {
          // Multiple answers with sorting capability
          userAnswers[currentQuestion].forEach((opt, idx) => {
            const div = document.createElement("div");
            div.classList.add("option");
            div.textContent = `${idx + 1}. ${opt}`; // Numbering untuk ordering
            div.draggable = true;
            div.ondragstart = (e) => dragStartOption(e, opt, true, idx);
            div.ondragover = (e) => dragOverAnswer(e, idx);
            div.ondrop = (e) => dropAnswer(e, idx);
            answerArea.appendChild(div);
          });
        } else {
          // Single answer
          const selectedAnswer = userAnswers[currentQuestion][0];
          const div = document.createElement("div");
          div.classList.add("option");
          div.textContent = selectedAnswer;
          div.style.cursor = "default";
          answerArea.appendChild(div);
        }
      }

      // Allow dropping to answer area
      answerArea.ondragover = (e) => dragOverAnswer(e, null);
      answerArea.ondrop = (e) => dropAnswer(e, null);

      document.getElementById("prevButton").disabled = currentQuestion === 0;
      document.getElementById("nextButton").textContent =
        currentQuestion === questions.length - 1 ? "Finish" : "Next";
    }

    // Drag and drop logic for sortable answers
    let dragData = null;
    function dragStartOption(e, opt, fromAnswer, idx) {
      dragData = { opt, fromAnswer, idx };
      e.dataTransfer.effectAllowed = "move";
    }

    function dragOverAnswer(e, idx) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
    }

    function dropAnswer(e, idx) {
      e.preventDefault();
      if (!dragData) return;

      const questionIndex = currentQuestion + 1;
      const isOrderingQuestion = (questionIndex === 5);

      if (isOrderingQuestion) {
        // Multiple answers with ordering - allow sorting
        let arr = userAnswers[currentQuestion];
        // Remove if dragged from answer area
        if (dragData.fromAnswer) {
          arr.splice(dragData.idx, 1);
        }
        // Insert at idx or push to end
        if (idx === null || idx === undefined) {
          arr.push(dragData.opt);
        } else {
          arr.splice(idx, 0, dragData.opt);
        }
      } else {
        // Single answer only - reset array dan masukkan jawaban baru
        userAnswers[currentQuestion] = [dragData.opt];
      }

      dragData = null;
      loadQuestion();
    }

    // DRAG-DROP HANDLERS
    function dragStart(e) {
      draggedElement = e.target;
      e.dataTransfer.setData("text/plain", e.target.textContent);
    }
    function dragEnd() {
      draggedElement = null;
    }
    function dragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add("drag-over");
    }
    function dragLeave(e) {
      e.currentTarget.classList.remove("drag-over");
    }
    function drop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove("drag-over");
      const answer = e.dataTransfer.getData("text/plain");
      userAnswers[currentQuestion] = answer;
      e.currentTarget.innerHTML = `<div><strong>${answer}</strong><br><small>(Click Next)</small></div>`;
      e.currentTarget.classList.add("filled");
    }

    // NAVIGASI
    document.getElementById("nextButton").addEventListener("click", () => {
      if (currentQuestion < questions.length - 1) {
        currentQuestion++;
        loadQuestion();
      } else {
        showResults();
      }
    });

    document.getElementById("prevButton").addEventListener("click", () => {
      if (currentQuestion > 0) {
        currentQuestion--;
        loadQuestion();
      }
    });

    // HASIL AKHIR
    async function showResults() {
      let correctCount = 0;
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const resultDetails = []; // Untuk menyimpan detail setiap jawaban

      questions.forEach((q, i) => {
        const questionNum = i + 1;
        const isOrderingQuestion = (questionNum === 5);
        let isCorrect = false;

        if (isOrderingQuestion) {
          // Untuk ordering question, compare entire array
          const userAnswer = userAnswers[i] || [];
          let correctAnswer = [];

          try {
            if (typeof q.correct_answer === 'string') {
              correctAnswer = JSON.parse(q.correct_answer);
            } else if (Array.isArray(q.correct_answer)) {
              correctAnswer = q.correct_answer;
            }
          } catch (e) {
            console.error("Error parsing correct_answer:", e);
          }

          // Compare arrays
          if (userAnswer.length === correctAnswer.length &&
              userAnswer.every((val, idx) => val === correctAnswer[idx])) {
            correctCount++;
            isCorrect = true;
          }

          // Simpan detail untuk ordering question
          resultDetails.push({
            question_id: q.id,
            user_answer: JSON.stringify(userAnswer), // Array as JSON string
            correct_answer: JSON.stringify(correctAnswer),
            is_correct: isCorrect
          });
        } else {
          // Untuk single choice question, ambil elemen pertama
          const userAnswer = userAnswers[i] && userAnswers[i][0] ? userAnswers[i][0] : null;
          if (userAnswer === q.correct_answer) {
            correctCount++;
            isCorrect = true;
          }

          // Simpan detail untuk single choice question
          resultDetails.push({
            question_id: q.id,
            user_answer: userAnswer || '',
            correct_answer: q.correct_answer,
            is_correct: isCorrect
          });
        }
      });

      // Simpan hasil ke Supabase jika user sudah login
      console.log("User data:", user); // Debug
      console.log("User ID:", user?.id); // Debug
      console.log("Result details to save:", resultDetails); // Debug

      if (user && user.id) {
        try {
          // Untuk setiap jawaban, cari answer_id dari quiz_options
          const answersToInsert = await Promise.all(
            resultDetails.map(async (detail) => {
              let answerId = null;

              // Untuk ordering question, user_answer adalah JSON string array
              // Untuk single choice, user_answer adalah string biasa
              const isOrderingAnswer = detail.user_answer.startsWith('[');

              if (!isOrderingAnswer && detail.user_answer) {
                // Untuk single choice, cari answer_id dari quiz_options
                const { data: optionData, error: optionError } = await supabase
                  .from('quiz_options')
                  .select('id')
                  .eq('question_id', detail.question_id)
                  .eq('option_text', detail.user_answer)
                  .maybeSingle();

                if (optionError) {
                  console.error('Error finding answer_id for question', detail.question_id, ':', optionError);
                } else if (optionData) {
                  answerId = optionData.id;
                  console.log(`Found answer_id ${answerId} for question ${detail.question_id}`);
                } else {
                  console.warn(`No option found for question ${detail.question_id} with text: ${detail.user_answer}`);
                }
              } else {
                console.log("Skipping answer_id for ordering question:", detail.question_id);
              }

              return {
                user_id: user.id,
                question_id: detail.question_id,
                answer_id: answerId,
                is_correct: detail.is_correct
              };
            })
          );

          console.log("Data yang akan di-insert:", answersToInsert); // Debug

          const { data, error } = await supabase
            .from('user_answers')
            .insert(answersToInsert)
            .select();

          if (error) {
            console.error('Error saving answers to Supabase:', error);
            console.error('Error details:', error.message, error.details, error.hint); // Debug
            alert('Failed to save answers: ' + error.message);
          } else {
            console.log('Answers saved successfully!', data);
            alert('Quiz completed! Your answers have been saved.');
          }
        } catch (err) {
          console.error('Error inserting user answers:', err);
          alert('Error: ' + err.message);
        }
      } else {
        console.log("User not logged in or user.id not found"); // Debug
        alert('Please login to save your quiz results!');
      }

      const percentage = Math.round((correctCount / questions.length) * 100);
      document.getElementById("quizContent").style.display = "none";
      document.getElementById("resultCard").style.display = "block";
      document.getElementById("scoreDisplay").textContent = percentage + "%";
    }

    // BALIK KE PILIHAN
    window.backToSelection = function () {
      document.getElementById("quizSelection").style.display = "block";
      document.getElementById("quizContent").style.display = "none";
      document.getElementById("resultCard").style.display = "none";
      currentMaterial = 0;
      questions = [];
      userAnswers = [];
    };

    // HANDLE PROFILE ICON & LOGOUT
    const user = localStorage.getItem('user');
    const profileIcon = document.getElementById('profileIcon');

    profileIcon.addEventListener('click', function() {
      if (user) {
        // User is logged in, show logout modal
        document.getElementById('logoutModal').classList.add('active');
      } else {
        // User is not logged in, redirect to login page
        window.location.href = 'login.html';
      }
    });

    window.closeLogoutModal = function() {
      document.getElementById('logoutModal').classList.remove('active');
    };

    window.confirmLogout = function() {
      localStorage.removeItem('user');
      alert('You have been logged out successfully!');
      window.location.href = 'login.html';
    };

    // Close modal when clicking outside
    document.getElementById('logoutModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeLogoutModal();
      }
    });
  </script>
</body>
</html>
